name: Publish products to systeme.io

on:
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    timeout-minutes: 40

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Node dependencies and Playwright
        run: |
          set -euo pipefail
          echo "Installing Node dependencies"
          npm install
          echo "Installing Playwright browsers"
          npx playwright install --with-deps

      - name: Run Node publisher with retries
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_BASE64 }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_COLLECTION: artifacts/husin-network/public/data/products
          SYSTEME_USER: ${{ secrets.SYSTEME_USER }}
          SYSTEME_PASS: ${{ secrets.SYSTEME_PASS }}
          GITHUB_RUN_ID: ${{ github.run_id }}
        run: |
          set -euo pipefail
          attempts=0
          max_attempts=3
          until [ $attempts -ge $max_attempts ]
          do
            attempts=$((attempts+1))
            echo "Node publish attempt $attempts/$max_attempts"
            if node publish.js; then
              echo "Node publisher succeeded on attempt $attempts"
              break
            else
              echo "Node publisher failed on attempt $attempts"
              ls -la || true
              sleep $((5 * attempts))
            fi
          done
          if [ $attempts -ge $max_attempts ]; then
            echo "Node publisher failed after $max_attempts attempts"
            exit 1
          fi

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            echo "Installing from requirements.txt"
            pip install -r requirements.txt
          else
            echo "requirements.txt not found; installing minimal runtime deps"
            pip install requests google-cloud-firestore google-auth || true
          fi
          if [ -f setup.py ] || [ -f pyproject.toml ]; then
            pip install -e .
          fi

      - name: Debug workspace and quick import test
        env:
          FIREBASE_SERVICE_ACCOUNT_BASE64: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_BASE64 }}
        run: |
          set -euo pipefail
          echo "=== workspace listing ==="
          ls -la
          echo "=== check agent1_core presence ==="
          ls -la agent1_core* || true
          echo "=== python version & pip ==="
          python3 --version || true
          python3 -m pip --version || true
          echo "=== quick import test (uses GITHUB_WORKSPACE from env) ==="
          python3 - <<'PY'

          python3 - <<'PY'
          import os, sys, importlib
          ws = os.environ.get('GITHUB_WORKSPACE', '.')
          print("Using workspace:", ws)
          sys.path.append(ws)
          importlib.invalidate_caches()
          def check(pkg):
              try:
                  importlib.import_module(pkg)
                  print(f"{pkg} import OK")
              except Exception as e:
                  print(f"ERROR_IMPORT::{pkg}::{type(e).__name__}::{e}")
                  print(f"::error::{pkg} import failed: {type(e).__name__} {e}")
          check('requests')
          check('google.cloud.firestore')
          try:
              import agent1_core
              print("agent1_core import OK")
          except Exception as e:
              print(f"ERROR_IMPORT::agent1_core::{type(e).__name__}::{e}")
              print(f"::error::agent1_core import failed: {type(e).__name__} {e}")
          PY

          echo "=== Create failure summary file ==="
          {
            echo "Run: $GITHUB_REPOSITORY@$GITHUB_SHA"
            echo "Run id: $GITHUB_RUN_ID"
            echo "Timestamp: $(date --utc +'%Y-%m-%dT%H:%M:%SZ')"
            echo
            echo "Node: $(node --version 2>/dev/null || echo 'node missing')"
            echo "npm: $(npm --version 2>/dev/null || echo 'npm missing')"
            echo "python: $(python3 --version 2>/dev/null || echo 'python missing')"
            echo
            echo "Files present:"
            ls -1 || true
            echo
            echo "Last 50 lines of Node step log (if publish.log exists):"
            if [ -f publish.log ]; then tail -n 50 publish.log; else echo "publish.log not found"; fi
            echo
            echo "Last 50 lines of Python step log (if python-publish.log exists):"
            if [ -f python-publish.log ]; then tail -n 50 python-publish.log; else echo "python-publish.log not found"; fi
          } > failure-summary.txt

          echo "=== FAILURE DIAGNOSTICS END ==="
          echo "failure-summary.txt created; it will be uploaded by the artifact step."

      - name: Upload logs and screenshots on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: publish-artifacts
          path: |
            *.png
            *.log
            publish-*.log
            failure-summary.txt
            playwright-report/**


      - name: Success marker
        if: success()
        run: echo "Publish workflow completed successfully."
